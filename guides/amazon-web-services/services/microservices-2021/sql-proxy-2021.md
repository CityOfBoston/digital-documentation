# SQL Proxy \(dbconnector\)

## Requirement

The City have a number of Data services \(e.g. SQL Servers\) that reside on the city network.  There is no mechanism by which data can be accessed from these services from processes that are not resident on the Cityhall network.  This includes boston.gov and other cloud based services.

## Service Specification

[Specification May 2021](https://docs.google.com/document/d/1jgzdX7X7V1SbOmna0Uo5TXbVPJnUKTV7NNdHKcNj4so/edit?usp=sharing)

## API User Guide

The dbconnector microservice is available from https://ssssssss.com.

The first step is to post to the **/auth** endpoint, providing a **username** and password.  If authenticated, an Authentication Token, and Refresh Token will be returned.  The Authentication Token is valid for 60 seconds, and the Refresh Token for 90 seconds.

The Authentication Token is then passed as a bearer authorization token and can be used multiple times until it expires.

When the Authentication Token expires, the Refresh Token can be passed to the **/auth/refresh** endpoint and a new Authentication Token will be returned with a 60 second lifetime.  A new Refresh Token will also be generated and returned with a 90 second lifetime.  Using the refresh token is faster and more efficient in the back-end as the user is not re-validated in the database, saving the database connection overhead.

Once authenticated the API can be used, provided the valid Token is passed in the header.

```text
HEADER "Authorization: bearer xxxx-xxxxx-xxxxx"
```

### Authentication

{% api-method method="post" host="" path="/auth" %}
{% api-method-summary %}
Authenticate User
{% endapi-method-summary %}

{% api-method-description %}
This endpoint is used to initially authenticate the user, and returns an Authentication Token which must be used in the header of all subsequent endpoint calls.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="post" host="" path="/auth/refresh" %}
{% api-method-summary %}
Refresh Authentication Token
{% endapi-method-summary %}

{% api-method-description %}
Using a valid Refresh Token \(provided from **/auth** endpoint\), this endpoint will refresh a current \(or expired\) Authentication Token.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

### User Management

{% api-method method="get" host="" path="/users" %}
{% api-method-summary %}
List all Users \(paged\)
{% endapi-method-summary %}

{% api-method-description %}
Returns a list of current users.  
Authentication Token must have been generated by a user with at least ADMIN role.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="get" host="" path="/users/:userid" %}
{% api-method-summary %}
List a single User
{% endapi-method-summary %}

{% api-method-description %}
Returns a single user.  
Authentication Token must have been generated by a user with at least ADMIN role, or by the user specified in userid.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="get" host="" path="/users/:userid/connections" %}
{% api-method-summary %}
List Connections available to a User
{% endapi-method-summary %}

{% api-method-description %}

{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="post" host="" path="/users" %}
{% api-method-summary %}
Add a new User
{% endapi-method-summary %}

{% api-method-description %}
Adds a new user.  
Authentication Token must have been generated by a user with at least ADMIN role.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="patch" host="" path="/users/:userid" %}
{% api-method-summary %}
Update an existing User
{% endapi-method-summary %}

{% api-method-description %}
Update the specified user.  
Authentication Token must have been generated by a user with at least ADMIN role, or by the user specified in userid.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="delete" host="" path="/user/userid" %}
{% api-method-summary %}
Delete an existing User
{% endapi-method-summary %}

{% api-method-description %}
Deletes the specified user.  
Authentication Token must have been generated by a user with at least ADMIN role.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

### Remote System Connections

{% api-method method="get" host="" path="" %}
{% api-method-summary %}
List all Connections \(paged\)
{% endapi-method-summary %}

{% api-method-description %}
Returns a list of all active remote system connection strings.  
Authentication Token must have been generated by a user with at least ADMIN role.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="get" host="" path="/connections/:token" %}
{% api-method-summary %}
List single Connection
{% endapi-method-summary %}

{% api-method-description %}
Returns the remote system connection string defined by the specified Connection Token.  
Authentication Token must have been generated by a user with at least ADMIN role, or by a user who can use the connection.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="get" host="" path="/connections/:token/users" %}
{% api-method-summary %}
List Users who may use a Connection
{% endapi-method-summary %}

{% api-method-description %}

{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="post" host="" path="/connection" %}
{% api-method-summary %}
Add a new Connection
{% endapi-method-summary %}

{% api-method-description %}
Saves a new remote system connection string.  
Authentication Token must have been generated by a user with at least ADMIN role.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="post" host="" path="/connections/:token/user/:userid" %}
{% api-method-summary %}
Permission User to use Connection
{% endapi-method-summary %}

{% api-method-description %}

{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="patch" host="" path="/connections/:token" %}
{% api-method-summary %}
Update an existing Connection
{% endapi-method-summary %}

{% api-method-description %}
Updates the remote system connection string defined by the specified Connection Token. Authentication Token must have been generated by a user with at least SUPER role
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="delete" host="" path="/connections/:token" %}
{% api-method-summary %}
Delete an existing Connection
{% endapi-method-summary %}

{% api-method-description %}
Deletes the remote system connection string defined by the specified Connection Token.  
Authentication Token must have been generated by a user with at least SUPER role.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="delete" host="" path="/connection/:token/user/:userid" %}
{% api-method-summary %}
Remove permission for User on Connection
{% endapi-method-summary %}

{% api-method-description %}

{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name="" type="string" required=false %}

{% endapi-method-parameter %}
{% endapi-method-path-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

### Execute Commands on Remote System

{% api-method method="post" host="" path="/query/:driver" %}
{% api-method-summary %}
Run SQL Query
{% endapi-method-summary %}

{% api-method-description %}
Runs a command \(or commands\) on the remote system.    
Depending on the command/s, returns a JSON Array \(of Arrays\) of Objects.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter required=true %}
The driver to use to execute the statement on the remote system.  
At this time, we only have **mssql**.
{% endapi-method-parameter %}
{% endapi-method-path-parameters %}

{% api-method-headers %}
{% api-method-parameter name="Authorization" type="string" required=true %}
A  valid Authentication Token in format:  
   "Bearer xxxxx-xxxxxx-xxxxxx"
{% endapi-method-parameter %}
{% endapi-method-headers %}

{% api-method-body-parameters %}
{% api-method-parameter name="connectionToken" type="string" required=true %}

{% endapi-method-parameter %}

{% api-method-parameter required=true %}
A single statement or command that can be executed on the remote system.
{% endapi-method-parameter %}

{% api-method-parameter name="args" type="string" required=false %}
A JSON string containing parameters to be substituted into the **statement** parameter.
{% endapi-method-parameter %}
{% endapi-method-body-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}
 
{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="post" host="" path="/select/:driver" %}
{% api-method-summary %}
Run Select Query
{% endapi-method-summary %}

{% api-method-description %}
This runs a command on the remote system which is expected to return a paged data set in a JSON  Array of Objects format.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-path-parameters %}
{% api-method-parameter name=":driver" type="string" required=true %}
The driver to use to execute the statement on the remote system.  
At this time, we only have **mssql.**
{% endapi-method-parameter %}
{% endapi-method-path-parameters %}

{% api-method-headers %}
{% api-method-parameter name="Authorization" type="string" required=true %}
A  valid Authentication Token in format:  
   "Bearer xxxxx-xxxxxx-xxxxxx"
{% endapi-method-parameter %}
{% endapi-method-headers %}

{% api-method-body-parameters %}
{% api-method-parameter name="connectionToken" required=true %}
A token
{% endapi-method-parameter %}

{% api-method-parameter name="statement" required=true %}
A single statement or command that can be executed on the remote system.
{% endapi-method-parameter %}

{% api-method-parameter name="args" type="string" required=false %}
A JSON string containing parameters to be substituted into the **statement** parameter.
{% endapi-method-parameter %}

{% api-method-parameter name="limit" type="string" required=true %}
Number of results to return in a page. 
{% endapi-method-parameter %}

{% api-method-parameter name="page" type="string" required=true %}
Page to be returned.
{% endapi-method-parameter %}
{% endapi-method-body-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="post" host="" path="/select/:driver" %}
{% api-method-summary %}

{% endapi-method-summary %}

{% api-method-description %}

{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-body-parameters %}
{% api-method-parameter name="args" type="string" required=false %}
A JSON string containing parameters to be substituted into the **statement** parameter.
{% endapi-method-parameter %}
{% endapi-method-body-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

{% api-method method="post" host="" path="/select/:driver" %}
{% api-method-summary %}

{% endapi-method-summary %}

{% api-method-description %}

{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-body-parameters %}
{% api-method-parameter name="" type="string" required=true %}
A token
{% endapi-method-parameter %}
{% endapi-method-body-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}

{% endapi-method-response-example-description %}

```

```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

#### Note on statement and args \(parameters\).

The statement field may contain "named tokens" which will be substituted into the statement prior to execution.

For Example: 

```text
statement: 'SELECT {a} FROM {c} ORDER BY {b};',
args: '{"a": "ID", "b": "CreateDate", "c": "dbo.users"}'
```

Expands out to:

```text
SELECT ID FROM dbo.users ORDER BY CreateDate;
```

